<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/font-awesome/4.6.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/daterangepicker.css">

    <!-- 引入 echarts.js -->
    <script src="jquery.js"></script>
    <script type="text/javascript" src="echarts.js"></script>
    <script src="package.js"></script>
</head>
<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
	<div class="col-sm-9">		
	</div>    
    <div>
        <div>
			<button type="button" class="btn btn-default pull-right" id="daterange-btn">
				<span>
				  <i class="fa fa-calendar"></i> 日期选择
				</span>
				<i class="fa fa-caret-down"></i>
			  </button>
		</div>
        <select id="selector">
            <option value="bot">By BOT</option>
            <option value="case">By Process</option>
        </select>
        <select id="selector1">
            <option value="1">BOT-1</option>
            <option value="2">BOT-2</option>
            <option value="3">BOT-3</option>
            <option value="4">BOT-4</option>
        </select>
        <div>
            <div id="barlineChart" style="width: 900px;height:400px;"></div> 
            <div id="linelineChart" style="width: 900px;height:400px;"></div> 
        </div>        
    </div>
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/moment.js"></script>
    <script type="text/javascript" src="js/daterangepicker.js"></script>
    <script type="text/javascript">
        $('#daterange-btn').daterangepicker({
                ranges: {
                    '今天': [moment(), moment()],
                    '本周': [moment().startOf('week'), moment().endOf('week')],
                    '本月': [moment().startOf('month'), moment().endOf('month')],
                    '今年': [moment().startOf('year'), moment().endOf('year')]
                },
                startDate: moment(),
                endDate: moment().endOf('month')
            },
            function(start, end) {
                $('#daterange-btn span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                alert(start.format('YYYYMMDD') + " " + end.format('YYYYMMDD'));
            }
        );
        //Date picker
        $('#datepicker').datepicker({
            autoclose: true
        });
    </script>

    <script type="text/javascript">
        // 基于准备好的dom，初始化echarts实例
        var barChart = echarts.init(document.getElementById('barlineChart'));
        var lineChart = echarts.init(document.getElementById('linelineChart'));
        
        // 指定图表的配置项和数据
        var optionCaseLine = {
            title: {
                text: "case"
            },
            tooltip: {},
            legend: {
                data:[]
            },
            xAxis: {
                data: []
            },
            yAxis: {},
            series: []
        };

        var optionTotal = {
            title: {
                "text": "Case Run Result Statistics",
                x: "4%",
                textStyle: {
                    color: '#000',
                    fontSize: '12'
                },
            
            },
            "tooltip": {
                "trigger": "axis",
                "axisPointer": {
                    "type": "shadow",
                    textStyle: {
                        color: "#fff"
                    }
                },
            },
            "grid": {
                "borderWidth": 0,
                "top": 110,
                "bottom": 95,
                textStyle: {
                    color: "#fff"
                }
            },
            "legend": {
                x: '4%',
                top: '8%',
                textStyle: {
                    color: '#90979c',
                },
                "data": ['Success', 'Failure']
            },
            "calculable": true,
            "xAxis": [{
                "type": "category",
                "axisLine": {
                    lineStyle: {
                        color: '#90979c'
                    }
                },
                "splitLine": {
                    "show": false
                },
                "axisTick": {
                    "show": false
                },
                "splitArea": {
                    "show": false
                },
                "axisLabel": {
                    "interval": 0,
                },
                "data": [],
            }],
            "yAxis": [{
                "type": "value",
                "splitLine": {
                    "show": false
                },
                "axisLine": {
                    lineStyle: {
                        color: '#90979c'
                    }
                },
                "axisTick": {
                    "show": false
                },
                "axisLabel": {
                    "interval": 0,
                    show: true,  
                    interval: 'auto',  
                    formatter: '{value}%' 

                },
                "splitArea": {
                    "show": false
                },
            }],
            "series": [{
                    "name": "Success",
                    "type": "bar",
                    "stack": "总量",
                    "barMaxWidth": 35,
                    "barGap": "10%",
                    "itemStyle": {
                        "normal": {
                            "color": "rgba(0,191,183,1)",
                            "label": {
                                "show": true,
                                "textStyle": {
                                    "color": "#fff"
                                },
                                "position": "inside",
                                formatter: function(p) {
                                    var a = p.value > 0 ? (p.value): '';     
                                    return a+"%";                       
                                }
                            }
                        }
                    },
                    "data": [],
                },
                {
                    "name": "Failure",
                    "type": "bar",
                    "stack": "总量",
                    "barMaxWidth": 35,                    
                    "barGap": "10%",
                    "itemStyle": {
                        "normal": {
                            "color": "rgba(255,144,128,1)",
                            "barBorderRadius": 0,
                            "label": {
                                "show": true,
                                "position": "inside",
                                formatter: function(p) {
                                    var a = p.value > 0 ? (p.value): '';     
                                    return a+"%";
                                }
                            }
                        }
                    },
                    "data": []
                },]
            }

        // 原始数据源
        var source = []
        source.push({case:"Case 1", bot:"BOT1", totalTimes:[100,100,100,100,100,100,100], successTimes:[10,20,30,40,50,60,70]})
        source.push({case:"Case 1", bot:"BOT2", totalTimes:[100,100,100,100,100,100,100], successTimes:[10,20,30,40,50,60,70]})
        source.push({case:"Case 1", bot:"BOT3", totalTimes:[100,100,100,100,100,100,100], successTimes:[10,20,30,40,50,60,70]})
        source.push({case:"Case 2", bot:"BOT1", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,50,40,10,80,90,80]})
        source.push({case:"Case 2", bot:"BOT2", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,50,40,10,80,90,80]})
        source.push({case:"Case 2", bot:"BOT3", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,50,40,10,80,90,80]})
        source.push({case:"Case 3", bot:"BOT1", totalTimes:[100,100,100,100,100,100,100], successTimes:[16,20,50,90,50,50,70]})
        source.push({case:"Case 3", bot:"BOT2", totalTimes:[100,100,100,100,100,100,100], successTimes:[16,20,50,90,50,50,70]})
        source.push({case:"Case 3", bot:"BOT3", totalTimes:[100,100,100,100,100,100,100], successTimes:[16,20,50,90,50,50,70]})
        source.push({case:"Case 4", bot:"BOT1", totalTimes:[100,100,100,100,100,100,100], successTimes:[18,40,20,80,20,20,80]})
        source.push({case:"Case 4", bot:"BOT2", totalTimes:[100,100,100,100,100,100,100], successTimes:[18,40,20,80,20,20,80]})
        source.push({case:"Case 4", bot:"BOT3", totalTimes:[100,100,100,100,100,100,100], successTimes:[18,40,20,80,20,20,80]})
        source.push({case:"Case 5", bot:"BOT1", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,90,70,70,50,90,70]})
        source.push({case:"Case 5", bot:"BOT2", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,90,70,70,50,90,70]})
        source.push({case:"Case 5", bot:"BOT3", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,90,70,70,50,90,70]})
        source.push({case:"Case 6", bot:"BOT1", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,90,70,70,50,90,70]})
        source.push({case:"Case 6", bot:"BOT2", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,90,70,70,50,90,70]})
        source.push({case:"Case 6", bot:"BOT3", totalTimes:[100,100,100,100,100,100,100], successTimes:[30,90,70,70,50,90,70]})

        var allCases = {}
        var allBots = {}
        for (let index = 0; index < source.length; index++) {
            const src = source[index];
            var cs = src.case
            var bot = src.bot
            allCases[cs] = '1'
            allBots[bot] = '1'
        }

        let length= Object.keys(allBots).length
        if (length > 0) {
            $("#selector").empty();
            $("#selector").append("<option value='bot'>By Bot</option>");
            $("#selector").append("<option value='case'>By Process</option>");

            $("#selector1").empty();
            for (const bot in allBots) {   
                $("#selector1").append("<option value="+bot+">"+bot+"</option>");
            }
            
            
            for (let index = 0; index < allBots.length; index++) {
                const element = array[index];
            }            
        }
        
        // 处理第一张图数据源
        var totalSource = []
        for (let index = 0; index < source.length; index++) {
            const src = source[index];
            var title = src.case
            var sum = eval(src.successTimes.join("+")); //求和
            var total = eval(src.totalTimes.join("+"));
            totalSource.push({name:title, totalTimes:total, successTimes:sum})
        }
        totalSource = totalSource.sort(function(a, b) {
            return a.successTimes - b.successTimes
        })

        var successData = []
        var failureData = []
        var xAxisData = []

        for (let index = 0; index < totalSource.length; index++) {
            const successTimes = totalSource[index].successTimes;
            const totalTimes = totalSource[index].totalTimes;
            var successRate = Math.trunc(successTimes/totalTimes * 100)
            var failureRate = 100 - successRate
            successData.push(successRate)
            failureData.push(failureRate)
            xAxisData.push(totalSource[index].name)
        }
        optionTotal.series[0].data = successData;
        optionTotal.series[1].data = failureData;
        optionTotal.xAxis[0].data = xAxisData
        barChart.setOption(optionTotal);

        function renderBarChartByBot(bot) {
            optionTotal.series = datas
            barChart.setOption(optionTotal)
        }

        // 处理第二张图数据源
        var xAxisLineData = []
        var lineData = []
        var legendData = []
        for (let index = 0; index < source.length; index++) {
            const src = source[index];
            var title = src.case
            lineData.push({name:title, type:'line', data:src.successTimes})
            legendData.push(title)
        }
        for (let index = 1; index <= source[0].successTimes.length; index++) {
            xAxisLineData.push("Day "+index) // 横轴
        }
        optionCaseLine.xAxis.data = xAxisLineData
        optionCaseLine.series = lineData
        optionCaseLine.legend.data = legendData
        // lineChart.setOption(optionCaseLine);    


        
        function renderLineChart(chart, datas) {
            // var option = lineChart.getOption()
            optionCaseLine.series = datas
            lineChart.setOption(optionCaseLine)
        }

        renderLineChart(optionCaseLine, lineData)

        // 鼠标移动动作
        barChart.on('mouseover', function (params) {
            var name = params.name
            var singleLineData = []
            for (let index = 0; index < source.length; index++) {
                const src = source[index];
                var title = src.case
                if(name == title) {
                    singleLineData.push({name:title, type:'line', data:src.successTimes})
                    break
                }                
            }
            optionCaseLine.series = singleLineData
            optionCaseLine.legend.data = [name]
            lineChart.setOption(optionCaseLine, true);
        });
        barChart.on('mouseout', function (params) {
            optionCaseLine.series = lineData
            optionCaseLine.legend.data = legendData
            lineChart.setOption(optionCaseLine, true);
        });


        $('#selector').change(function (e) {
            $("#selector1").empty();
            var sel0 =  $('#selector').val()
            if (sel0 == "bot") {
                $("#selector1").append("<option value='1'>BOT-1</option>");
                $("#selector1").append("<option value='2'>BOT-2</option>");
                $("#selector1").append("<option value='3'>BOT-3</option>");
                $("#selector1").append("<option value='4'>BOT-4</option>");
                option3.series = bots[0];
                lineChart.setOption(optionCaseLine);
            } else if (sel0 == "case") {
                $("#selector1").append("<option value='1'>CASE-1</option>");
                $("#selector1").append("<option value='2'>CASE-2</option>");
                $("#selector1").append("<option value='3'>CASE-3</option>");
                $("#selector1").append("<option value='4'>CASE-4</option>");
                option3.series = cases[0];
                lineChart.setOption(optionCaseLine);
            }   
            
        });
        $('#selector1').change(function (e) {
            var sel0 =  $('#selector').val()
            var src = bots
            if (sel0 == "bot") {
                src = bots
            } else if (sel0 == "case") {
                src = cases
            }
            optionCaseLine.series = src[$('#selector1').val()];
            lineChart.setOption(optionCaseLine);
        });
    </script>
</body>
</html>